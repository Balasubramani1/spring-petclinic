pipeline {
    agent any
    stages {
        stage('Git Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Maven Validate') {
            steps {
                sh './mvnw validate'
            }
        }
        stage('Maven Compile') {
            steps {
                sh './mvnw compile'
            }
        }
        stage('Maven Test') {
            steps {
                sh './mvnw test'
            }
        }
        stage('Maven Package') {
            steps {
                sh './mvnw package'
            }
        }
        // stage('SonarCloud Analysis') {
        //     steps {
        //         withCredentials([string(credentialsId: '	sonarqube-token', variable: 'SONAR_TOKEN')]) {
        //             sh './mvnw sonar:sonar -Dsonar.login=$SONAR_TOKEN'
        //         }
        //     }
        // }
        stage('Build Docker Image') {
            steps {
                sh './mvnw spring-boot:build-image'
            }
        }
        stage('Login to ACR and Push Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: '06f82b08-20f6-4a6e-887b-4eed929a2f6a', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh '''
                        echo "$PASSWORD" | docker login luckyregistry.azurecr.io -u "$USERNAME" --password-stdin
                        docker tag spring-petclinic:3.5.0-SNAPSHOT luckyregistry.azurecr.io/spring-petclinic:latest
                        docker push luckyregistry.azurecr.io/spring-petclinic:latest
                    '''
                }
            }
        }

        stage('Scan Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: '06f82b08-20f6-4a6e-887b-4eed929a2f6a', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh '''
                        echo "$PASSWORD" | docker login luckyregistry.azurecr.io -u "$USERNAME" --password-stdin
                        trivy image luckyregistry.azurecr.io/spring-petclinic:latest
                    '''
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh 'kubectl apply -f k8s/db.yml'
            }
        }
    }
}
